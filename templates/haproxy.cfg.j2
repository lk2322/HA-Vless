global
    log /dev/log local0
    log /dev/log local1 notice
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    
    # Enable health checks
    option tcp-check

# Stats page for monitoring
{% if monitoring_enabled | default(true) %}
frontend stats
    bind *:9101
    mode http
    http-request use-service prometheus-exporter if { path /metrics }
    stats enable
    stats uri /stats
    stats refresh 10s
{% endif %}

# VLESS over TLS frontend
frontend ft_xray
    bind *:443
    mode tcp
    option tcplog
    default_backend bk_xray

{% if xray_http_enabled | default(false) %}
# HTTP proxy frontend
frontend ft_http_proxy
    bind *:{{ haproxy_http_port | default(8080) }}
    mode tcp
    option tcplog
    default_backend bk_http_proxy
{% endif %}

# VLESS backend
backend bk_xray
    mode tcp
    # Use source-based load balancing for better session persistence
    balance source
    hash-type consistent
    # Health check interval
    default-server inter 5s downinter 5s rise 2 fall 1
    
    # Main servers
{% for host in groups['xray_main'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ xray_port }} check agent-check agent-addr {{ hostvars[host]['ansible_host'] }} agent-port {{ xray_agent_port | default(8192) }} agent-inter 30s weight 100
{% endfor %}
    
    # Backup servers (with lower weight)
{% for host in groups['xray_backup'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ xray_port }} check agent-check agent-addr {{ hostvars[host]['ansible_host'] }} agent-port {{ xray_agent_port | default(8192) }} agent-inter 30s backup weight 50
{% endfor %}

{% if xray_http_enabled | default(false) %}
# HTTP proxy backend
backend bk_http_proxy
    mode tcp
    balance source
    hash-type consistent
    default-server inter 10s downinter 5s rise 2 fall 3
    
    # Main servers
    {% for host in groups['xray_main'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ xray_http_port | default(8080) }} check agent-check agent-addr {{ hostvars[host]['ansible_host'] }} agent-port {{ xray_agent_port | default(8192) }} agent-inter 30s weight 100
    {% endfor %}
    
    # Backup servers (with lower weight)
    {% for host in groups['xray_backup'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ xray_http_port | default(8080) }} check agent-check agent-addr {{ hostvars[host]['ansible_host'] }} agent-port {{ xray_agent_port | default(8192) }} agent-inter 30s backup weight 50
    {% endfor %}
{% endif %}
